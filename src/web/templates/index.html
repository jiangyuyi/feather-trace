<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FeatherTrace Gallery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* å…¨å±€æ ·å¼ */
        body {
            font-size: 14px;
        }

        .card-img-top {
            height: 250px;
            object-fit: cover;
            cursor: pointer;
        }
        .confidence-high { color: green; }
        .confidence-med { color: orange; }
        .confidence-low { color: red; }
        .card.status-uncertain { border: 2px solid #ffc107; }
        .badge-uncertain { background-color: #ffc107 !important; color: #000; }
        .original-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            display: none;
        }
        .card:hover .original-badge { display: block; }
        .location-tag {
            font-size: 0.8rem;
            color: #666;
        }
        .path-info {
            font-size: 0.75rem;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ç…§ç‰‡ç½‘æ ¼å¸ƒå±€ - ä½¿ç”¨CSS Gridç¡®ä¿æ¯å¼ å›¾ç‰‡ç­‰å®½ */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            width: 100%;
        }

        .photo-grid .photo-card {
            min-width: 0; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }

        /* å“åº”å¼è°ƒæ•´ï¼šå¹³æ¿3åˆ—ï¼Œæ‰‹æœº2åˆ— */
        @media (max-width: 991.98px) {
            .photo-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (max-width: 767.98px) {
            .photo-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 80px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
        }

        .sidebar-body {
            padding: 0;
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
        }

        .taxonomy-tree {
            /* ç§»é™¤max-heightï¼Œè®©å†…å®¹è‡ªç„¶æ»šåŠ¨ */
            padding: 8px 0;
        }

        /* æ ‘å½¢èŠ‚ç‚¹æ ·å¼ */
        .tree-node {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        .tree-node:hover {
            background-color: #f8f9fa;
        }
        .tree-node.active {
            background-color: #0d6efd;
            color: white;
            font-weight: 500;
        }
        .tree-children {
            margin-left: 16px;
            display: none;
        }
        .tree-children.expanded {
            display: block;
        }
        .tree-toggle {
            display: inline-block;
            width: 16px;
            text-align: center;
            margin-right: 6px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .tree-toggle:hover {
            transform: scale(1.1);
        }
        .node-count {
            font-size: 0.75rem;
            color: #666;
            margin-left: 6px;
            opacity: 0.8;
        }
        .tree-node.active .node-count {
            color: rgba(255,255,255,0.9);
        }

        /* åˆ†ç±»ä¿¡æ¯é¢æ¿ */
        .taxonomy-info {
            font-size: 0.8rem;
            color: #666;
            padding: 8px 12px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
            display: none;
            flex-shrink: 0;
        }
        .taxonomy-info.expanded {
            display: block;
        }

        /* ä¼˜åŒ–æŒ‰é’®æ ·å¼ */
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        /* çŠ¶æ€æ  */
        .status-bar {
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™æ»šåŠ¨åŠŸèƒ½ */
        .taxonomy-tree::-webkit-scrollbar {
            width: 6px;
        }
        .taxonomy-tree::-webkit-scrollbar-thumb {
            background: #dee2e6;
            border-radius: 3px;
        }
        .taxonomy-tree::-webkit-scrollbar-thumb:hover {
            background: #adb5bd;
        }

    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">FeatherTrace</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link {{ 'active' if not current_filter }}" href="/">Gallery</a></li>
                    <li class="nav-item"><a class="nav-link {{ 'active' if current_filter == 'uncertain' }}" href="/?filter=uncertain">âš ï¸ Uncertain</a></li>
                    <li class="nav-item"><a class="nav-link" href="/admin">Admin & Tasks</a></li>
                </ul>

                <!-- Filters Form -->
                <form class="d-flex me-2" action="/" method="get">
                    <input type="hidden" name="filter" value="{{ current_filter }}">
                    <input type="hidden" name="q" value="{{ query }}">

                    <select class="form-select me-2" name="date" onchange="this.form.submit()" style="width: auto;">
                        <option value="">All Dates</option>
                        {% for d in available_dates %}
                        <option value="{{ d }}" {{ 'selected' if current_date == d }}>{{ d }}</option>
                        {% endfor %}
                    </select>

                    <select class="form-select me-2" name="limit" onchange="this.form.submit()" style="width: auto;">
                        <option value="20" {{ 'selected' if limit == 20 }}>20</option>
                        <option value="50" {{ 'selected' if limit == 50 }}>50</option>
                        <option value="100" {{ 'selected' if limit == 100 }}">100</option>
                    </select>
                </form>

                <form class="d-flex" action="/" method="get">
                    <input class="form-control me-2" type="search" name="q" placeholder="Search..." value="{{ query }}">
                    <button class="btn btn-outline-light" type="submit">Search</button>
                </form>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4 px-4">
        <div class="row">
            <!-- å·¦ä¾§ä¾§è¾¹æ ï¼šåˆ†ç±»æ ‘ -->
            <div class="col-md-3">
                <div class="card sidebar h-100">
                    <div class="sidebar-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">ç‰©ç§åˆ†ç±»</h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary btn-sm" id="expand-all-btn" title="å±•å¼€æ‰€æœ‰">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M3 10a2 2 0 0 1 0-4v2a2 2 0 0 1 0 4h10a2 2 0 0 1 0-4v-2a2 2 0 0 1 0-4H3z"/>
                                    <path d="M3 14a2 2 0 0 1 0 4v2a2 2 0 0 1 0 4h10a2 2 0 0 1 0-4v-2a2 2 0 0 1 0-4H3z"/>
                                    <path d="M3 6a2 2 0 0 1 0 4v2a2 2 0 0 1 0 4h10a2 2 0 0 1 0-4V6a2 2 0 0 1 0-4H3z"/>
                                </svg>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" id="collapse-all-btn" title="æŠ˜å æ‰€æœ‰">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M6 10a2 2 0 0 1 0-4v2a2 2 0 0 1 0 4h4a2 2 0 0 1 0-4v-2a2 2 0 0 1 0-4H6z"/>
                                    <path d="M6 14a2 2 0 0 1 0 4v2a2 2 0 0 1 0 4h4a2 2 0 0 1 0-4v-2a2 2 0 0 1 0-4H6z"/>
                                    <path d="M6 6a2 2 0 0 1 0 4v2a2 2 0 0 1 0 4h4a2 2 0 0 1 0-4V6a2 2 0 0 1 0-4H6z"/>
                                </svg>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" id="reset-tree-btn" title="å¤ä½">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 3a5 5 0 1 0 0 10 5 5 0 0 0 0-10 0 5 0 0 0 0 10zm0 2.5a2.5 2.5 0 1 1 2.5 2.5 0 0 1 1-2.5 2.5 0 0 1 1 2.5 0 0 1 1-2.5zm0 5a2.5 2.5 0 1 1 2.5 2.5 0 0 1 1 2.5 2.5 0 0 1 1 2.5 0 0 1 1-2.5z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="sidebar-body">
                        <div class="taxonomy-tree" id="taxonomy-tree">
                            <div class="text-center text-muted py-3">åŠ è½½ä¸­...</div>
                        </div>
                    </div>
                    <div class="taxonomy-info" id="taxonomy-info"></div>
                </div>
            </div>

            <!-- å³ä¾§ä¸»å†…å®¹ï¼šç…§ç‰‡ç½‘æ ¼ -->
            <div class="col-md-9">
                <!-- Status Bar -->
                <div class="status-bar">
                    <span class="text-muted small">
                        Showing {{ offset + 1 }}-{{ offset + photos|length }} of {{ total_count }} photos
                        {% if current_date %} | Date: {{ current_date }} {% endif %}
                        {% if query %} | Query: "{{ query }}" {% endif %}
                    </span>
                    <!-- åŠ¨æ€åˆ†é¡µæŒ‰é’®ç”±JavaScriptæ¸²æŸ“ -->
                </div>

                {% if not photos %}
                    <div class="alert alert-info">No photos found. Try changing filters.</div>
                {% endif %}

                <div id="photo-gallery-container" class="photo-grid">
                    {% for photo in photos %}
                    {% set is_uncertain = (photo.primary_bird_cn == 'å¾…ç¡®è®¤é¸Ÿç§' or photo.scientific_name == 'Uncertain') %}
                    {% set processed_path = photo.web_processed_path if photo.web_processed_path else '' %}
                    {% set raw_path = photo.web_raw_path if photo.web_raw_path else '' %}
                    <div class="photo-card">
                        <div class="card h-100 shadow-sm {{ 'status-uncertain' if is_uncertain else '' }}">
                            <div class="position-relative">
                                <!-- Image: Toggle between processed and raw -->
                                <img src="{{ processed_path }}"
                                     class="card-img-top main-img"
                                     data-processed="{{ processed_path }}"
                                     data-raw="{{ raw_path }}"
                                     alt="{{ photo.primary_bird_cn }}"
                                     loading="lazy">
                                <span class="original-badge">Hold to view Original</span>
                            </div>

                            <div class="card-body">
                                <h5 class="card-title">
                                    {{ photo.primary_bird_cn }}
                                    {% if is_uncertain %}
                                    <span class="badge badge-uncertain small align-top">?</span>
                                    {% endif %}
                                </h5>
                                <h6 class="card-subtitle mb-2 text-muted fst-italic">{{ photo.scientific_name }}</h6>

                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="location-tag">ğŸ“ {{ photo.location_tag }}</span>
                                    <span class="badge bg-light text-dark border">
                                        {{ (photo.confidence_score * 100)|int }}%
                                    </span>
                                </div>

                                <div class="path-info" title="{{ photo.filename }}">
                                    ğŸ“ {{ photo.filename }}
                                </div>

                                <div class="d-grid gap-2 mt-3">
                                    <button class="btn btn-sm btn-outline-primary edit-btn"
                                            data-id="{{ photo.id }}"
                                            data-sci="{{ photo.scientific_name }}"
                                            data-cn="{{ photo.primary_bird_cn }}"
                                            data-candidates='{{ photo.candidates_json | default("[]") }}'>
                                        âœï¸ Correct ID
                                    </button>
                                    <div class="btn-group btn-group-sm">
                                        {% if processed_path %}
                                        <a href="{{ processed_path }}" download class="btn btn-outline-secondary">Download Crop</a>
                                        {% endif %}
                                        {% if raw_path %}
                                        <a href="{{ raw_path }}" download class="btn btn-outline-secondary">Original</a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer text-muted small">
                                {{ photo.captured_date }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Pagination Bottom (ç”±JavaScriptåŠ¨æ€æ¸²æŸ“ï¼Œé™æ€å ä½ç¬¦ä¿ç•™ç»“æ„) -->
                <div class="d-flex justify-content-center mt-4 mb-5" id="pagination-bottom">
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Correct Identification</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-photo-id">

                    <!-- AI Candidates Section -->
                    <div id="ai-candidates-section" class="mb-3 d-none">
                        <label class="form-label text-muted small">AI Alternatives (Click to Select)</label>
                        <div id="ai-candidates-list" class="list-group mb-3"></div>
                        <hr>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Search Manual Override</label>
                        <input type="text" class="form-control" id="species-search" placeholder="Type name...">
                        <div id="search-results" class="list-group mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ========================
        // 0. Configuration
        // ========================
        const CONFIG = {
            defaultExpandLevel: 'none',  // 'none': ä¸å±•å¼€ä»»ä½•èŠ‚ç‚¹, 'order': å±•å¼€åˆ°ç›®, 'family': å±•å¼€åˆ°ç§‘, 'genus': å±•å¼€åˆ°å±
            includeEmptyNodes: false,    // é»˜è®¤ä¸æ˜¾ç¤ºç©ºèŠ‚ç‚¹
            rememberExpandState: true,  // è®°ä½ç”¨æˆ·å±•å¼€çŠ¶æ€
            expandStateKey: 'feathertrace_tree_expand_state'
        };

        // ========================
        // 1. Taxonomy Tree Logic
        // ========================
        let currentTaxonomyFilter = null; // {type: 'order'|'family'|'genus'|'species', value: string}
        let currentTaxonomyTree = null;
        let currentOffset = 0;  // å½“å‰åˆ†é¡µåç§»é‡
        let currentLimit = {{ limit }};  // ä»æœåŠ¡å™¨åŒæ­¥limitå€¼
        let expandState = {};

        // åŠ è½½ä¿å­˜çš„å±•å¼€çŠ¶æ€
        function loadExpandState() {
            try {
                const saved = localStorage.getItem(CONFIG.expandStateKey);
                if (saved) {
                    expandState = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Failed to load expand state:', e);
            }
        }

        // ä¿å­˜å±•å¼€çŠ¶æ€
        function saveExpandState() {
            try {
                localStorage.setItem(CONFIG.expandStateKey, JSON.stringify(expandState));
            } catch (e) {
                console.error('Failed to save expand state:', e);
            }
        }

        function loadTaxonomyTree(includeEmpty = CONFIG.includeEmptyNodes, dateFilter = null, defaultLevel = CONFIG.defaultExpandLevel) {
            const treeContainer = document.getElementById('taxonomy-tree');
            treeContainer.innerHTML = '<div class="text-center text-muted py-3">åŠ è½½ä¸­...</div>';

            let url = `/api/taxonomy/tree?include_empty=${includeEmpty}`;
            if (dateFilter) {
                url += `&date=${dateFilter}`;
            }

            fetch(url)
                .then(r => {
                    if (!r.ok) throw new Error('Network response was not ok');
                    return r.json();
                })
                .then(data => {
                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid data format: expected array');
                    }
                    currentTaxonomyTree = data;
                    if (!data || data.length === 0) {
                        treeContainer.innerHTML = '<div class="text-center text-muted py-3">æš‚æ— æ•°æ®</div>';
                        return;
                    }
                    renderTree(data, treeContainer, defaultLevel);
                })
                .catch(err => {
                    console.error('Failed to load taxonomy tree:', err);
                    treeContainer.innerHTML = '<div class="text-center text-danger py-3">åŠ è½½å¤±è´¥: ' + err.message + '</div>';
                });
        }

        function renderTree(orders, container, expandToLevel = CONFIG.defaultExpandLevel) {
            container.innerHTML = '';
            const ul = document.createElement('ul');
            ul.className = 'list-unstyled ps-0';
            ul.style.marginBottom = '0';

            orders.forEach(order => {
                const li = renderOrderNode(order, expandToLevel);
                if (li) ul.appendChild(li);  // åªæ·»åŠ énullçš„èŠ‚ç‚¹
            });

            container.appendChild(ul);
        }

        function renderOrderNode(order, expandToLevel) {
            // æ£€æŸ¥æ˜¯å¦åº”è¯¥æ¸²æŸ“è¯¥èŠ‚ç‚¹ï¼ˆä¸åŒ…å«ç©ºèŠ‚ç‚¹ï¼‰
            if (!order.photo_count && !CONFIG.includeEmptyNodes) {
                return null;
            }

            const li = document.createElement('li');
            li.style.marginBottom = '2px';

            const node = document.createElement('div');
            node.className = 'tree-node';
            node.dataset.type = 'order';
            node.dataset.value = order.order_cn;
            node.dataset.sci = order.order_sci;
            node.innerHTML = `
                <span class="tree-toggle">â–¶</span>
                ${order.order_cn}
                <span class="node-count">(${order.photo_count})</span>
            `;

            // æ£€æŸ¥æ˜¯å¦åº”è¯¥å±•å¼€
            const shouldExpand = expandToLevel === 'order' || expandState[`order_${order.order_cn}`];
            const childrenDiv = document.createElement('div');
            childrenDiv.className = 'tree-children' + (shouldExpand ? ' expanded' : '');

            // æ¸²æŸ“å­èŠ‚ç‚¹
            if (order.families && order.families.length > 0) {
                order.families.forEach(family => {
                    const familyLi = renderFamilyNode(family, order.order_sci, expandToLevel);
                    if (familyLi) {
                        childrenDiv.appendChild(familyLi);
                    }
                });
            }

            node.onclick = (e) => {
                e.stopPropagation();
                toggleNode(node);
                filterByTaxonomy('order', order.order_cn, order.order_sci);
            };

            li.appendChild(node);
            li.appendChild(childrenDiv);
            return li;
        }

        function renderFamilyNode(family, orderSci, expandToLevel) {
            // æ£€æŸ¥æ˜¯å¦åº”è¯¥æ¸²æŸ“è¯¥èŠ‚ç‚¹
            if (family.photo_count === 0 && !CONFIG.includeEmptyNodes) {
                return null;
            }

            const li = document.createElement('li');
            li.style.marginBottom = '2px';

            const node = document.createElement('div');
            node.className = 'tree-node';
            node.dataset.type = 'family';
            node.dataset.value = family.family_cn;
            node.dataset.sci = family.family_sci;
            node.innerHTML = `
                <span class="tree-toggle">â–¶</span>
                ${family.family_cn}
                <span class="node-count">(${family.photo_count})</span>
            `;

            const shouldExpand = expandToLevel === 'family' || expandState[`family_${family.family_cn}`];
            const childrenDiv = document.createElement('div');
            childrenDiv.className = 'tree-children' + (shouldExpand ? ' expanded' : '');

            if (family.genera && family.genera.length > 0) {
                family.genera.forEach(genus => {
                    const genusLi = renderGenusNode(genus, orderSci, family.family_sci, expandToLevel);
                    if (genusLi) {
                        childrenDiv.appendChild(genusLi);
                    }
                });
            }

            node.onclick = (e) => {
                e.stopPropagation();
                toggleNode(node);
                filterByTaxonomy('family', family.family_cn, orderSci, node.dataset.sci);
            };

            li.appendChild(node);
            li.appendChild(childrenDiv);
            return li;
        }

        function renderGenusNode(genus, orderSci, familySci, expandToLevel) {
            // æ£€æŸ¥æ˜¯å¦åº”è¯¥æ¸²æŸ“è¯¥èŠ‚ç‚¹
            if (genus.photo_count === 0 && !CONFIG.includeEmptyNodes) {
                return null;
            }

            const li = document.createElement('li');
            li.style.marginBottom = '2px';

            const node = document.createElement('div');
            node.className = 'tree-node';
            node.dataset.type = 'genus';
            node.dataset.value = genus.genus_cn;
            node.dataset.sci = genus.genus_sci;
            node.innerHTML = `
                <span class="tree-toggle">â–¶</span>
                ${genus.genus_cn}
                <span class="node-count">(${genus.photo_count})</span>
            `;

            const shouldExpand = expandToLevel === 'genus' || expandState[`genus_${genus.genus_cn}`];
            const childrenDiv = document.createElement('div');
            childrenDiv.className = 'tree-children' + (shouldExpand ? ' expanded' : '');

            if (genus.species && genus.species.length > 0) {
                genus.species.forEach(sp => {
                    const spLi = renderSpeciesNode(sp, orderSci, familySci, genus.genus_sci);
                    if (spLi) childrenDiv.appendChild(spLi);
                });
            }

            node.onclick = (e) => {
                e.stopPropagation();
                toggleNode(node);
                filterByTaxonomy('genus', genus.genus_cn, orderSci, familySci, node.dataset.sci);
            };

            li.appendChild(node);
            li.appendChild(childrenDiv);
            return li;
        }

        function renderSpeciesNode(species, orderSci, familySci, genusSci) {
            // æ£€æŸ¥æ˜¯å¦åº”è¯¥æ¸²æŸ“è¯¥èŠ‚ç‚¹ï¼ˆphoto_count ä¸º 0 æ—¶ä¸æ¸²æŸ“ï¼‰
            if (species.photo_count === 0 && !CONFIG.includeEmptyNodes) {
                return null;
            }

            const li = document.createElement('li');
            li.style.marginBottom = '2px';

            const node = document.createElement('div');
            node.className = 'tree-node';
            node.dataset.type = 'species';
            node.dataset.value = species.scientific_name;
            node.dataset.sci = species.scientific_name;
            node.innerHTML = `
                <span class="tree-toggle" style="visibility: hidden;">â—¦</span>
                ${species.chinese_name}
                <span class="node-count">(${species.photo_count})</span>
            `;
            node.onclick = (e) => {
                e.stopPropagation();
                highlightNode(node);
                filterByTaxonomy('species', species.scientific_name, orderSci, familySci, genusSci);
            };

            li.appendChild(node);
            return li;
        }

        function toggleNode(node) {
            const children = node.nextElementSibling;
            const toggle = node.querySelector('.tree-toggle');

            if (children && children.classList.contains('tree-children')) {
                const isExpanded = children.classList.toggle('expanded');
                toggle.textContent = isExpanded ? 'â–¼' : 'â–¶';

                // ä¿å­˜å±•å¼€çŠ¶æ€
                const type = node.dataset.type;
                const value = node.dataset.value;
                if (type && value) {
                    expandState[`${type}_${value}`] = isExpanded;
                    if (CONFIG.rememberExpandState) {
                        saveExpandState();
                    }
                }
            }
        }

        function highlightNode(node) {
            // Remove active class from all nodes
            document.querySelectorAll('.tree-node.active').forEach(n => n.classList.remove('active'));
            // Add active class to current node
            node.classList.add('active');
        }

        function filterByTaxonomy(type, value, orderSsci = null, familySsci = null, genusSsci = null) {
            currentTaxonomyFilter = { type, value, orderSsci, familySsci, genusSsci };
            currentOffset = 0;

            // Build URL
            let url = `/api/photos/by_taxonomy?`;

            // ä½¿ç”¨æ‹‰ä¸åï¼ˆssiï¼‰æ„å»ºæŸ¥è¯¢å‚æ•°ï¼Œé¿å…ä¸­æ–‡ç¼–ç é—®é¢˜
            if (orderSsci) url += `order_sci=${encodeURIComponent(orderSsci)}&`;
            if (familySsci) url += `family_sci=${encodeURIComponent(familySsci)}&`;
            if (genusSsci) url += `genus_sci=${encodeURIComponent(genusSsci)}&`;
            if (value && type === 'species') url += `scientific_name=${encodeURIComponent(value)}&`;
            url += `limit=${currentLimit}&offset=0`;

            // Update taxonomy info panel
            updateTaxonomyInfo(type, value);

            // Update photos grid
            updatePhotoGrid(url);
        }

        function updateTaxonomyInfo(type, value) {
            const infoPanel = document.getElementById('taxonomy-info');
            if (!infoPanel) return;

            let info = '';
            switch (type) {
                case 'order':
                    info = `<strong>ç›®:</strong> ${value}`;
                    break;
                case 'family':
                    info = `<strong>ç§‘:</strong> ${value}`;
                    break;
                case 'genus':
                    info = `<strong>å±:</strong> ${value}`;
                    break;
                case 'species':
                    info = `<strong>ç‰©ç§:</strong> ${value}`;
                    break;
            }
            infoPanel.innerHTML = info;
            infoPanel.classList.add('expanded');
        }

        function updatePhotoGrid(url) {
            const photosContainer = document.getElementById('photo-gallery-container');
            const statusContainer = document.querySelector('.status-bar');

            if (statusContainer) {
                statusContainer.innerHTML = '<span class="text-muted small">åŠ è½½ä¸­...</span>';
            }

            if (photosContainer) {
                photosContainer.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border" role="status"></div></div>';
            }

            fetch(url)
                .then(r => r.json())
                .then(data => {
                    renderPhotos(data.photos);
                    updateStatus(data, url);
                })
                .catch(err => {
                    console.error('Failed to load photos:', err);
                    if (photosContainer) {
                        photosContainer.innerHTML = '<div class="col-12 text-center text-danger py-5">åŠ è½½å¤±è´¥</div>';
                    }
                });
        }

        function renderPhotos(photos) {
            const photosContainer = document.getElementById('photo-gallery-container');
            if (!photosContainer) return;

            if (!photos || photos.length === 0) {
                photosContainer.innerHTML = '<div class="text-center py-5 w-100"><div class="alert alert-warning">è¯¥åˆ†ç±»ä¸‹æš‚æ— ç…§ç‰‡</div></div>';
                return;
            }

            let html = '';
            for (let i = 0; i < photos.length; i++) {
                const photo = photos[i];
                const isUncertain = photo.primary_bird_cn === 'å¾…ç¡®è®¤é¸Ÿç§' || photo.scientific_name === 'Uncertain';
                // é˜²æ­¢ null å€¼ç”Ÿæˆ /null è·¯å¾„
                const processedPath = photo.web_processed_path || '';
                const rawPath = photo.web_raw_path || '';

                html += `
                <div class="photo-card">
                    <div class="card h-100 shadow-sm ${isUncertain ? 'status-uncertain' : ''}">
                        <div class="position-relative">
                            <img src="${processedPath}"
                                 class="card-img-top main-img"
                                 data-processed="${processedPath}"
                                 data-raw="${rawPath}"
                                 alt="${photo.primary_bird_cn}"
                                 loading="lazy">
                            <span class="original-badge">Hold to view Original</span>
                        </div>

                        <div class="card-body">
                            <h5 class="card-title">
                                ${photo.primary_bird_cn}
                                ${isUncertain ? '<span class="badge badge-uncertain small align-top">?</span>' : ''}
                            </h5>
                            <h6 class="card-subtitle mb-2 text-muted fst-italic">${photo.scientific_name}</h6>

                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="location-tag">ğŸ“ ${photo.location_tag}</span>
                                <span class="badge bg-light text-dark border">
                                    ${(photo.confidence_score * 100).toFixed(0)}%
                                </span>
                            </div>

                            <div class="path-info" title="${photo.filename}">
                                ğŸ“ ${photo.filename}
                            </div>

                            <div class="d-grid gap-2 mt-3">
                                <button class="btn btn-sm btn-outline-primary edit-btn"
                                        data-id="${photo.id}"
                                        data-sci="${photo.scientific_name}"
                                        data-cn="${photo.primary_bird_cn}"
                                        data-candidates='${photo.candidates_json || "[]"}'>
                                    âœï¸ Correct ID
                                </button>
                                <div class="btn-group btn-group-sm">
                                    ${processedPath ? `<a href="${processedPath}" download class="btn btn-outline-secondary">Download Crop</a>` : ''}
                                    ${rawPath ? `<a href="${rawPath}" download class="btn btn-outline-secondary">Original</a>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="card-footer text-muted small">
                            ${photo.captured_date}
                        </div>
                    </div>
                </div>
                `;
            }

            photosContainer.innerHTML = html;

            // Re-attach event handlers
            attachImageToggleHandlers();
            attachEditModalHandlers();
        }

        function updateStatus(data, url) {
            const statusContainer = document.querySelector('.status-bar');
            if (!statusContainer) return;

            const total = data.total_count || 0;
            const offset = data.offset || currentOffset;
            const limit = data.limit || currentLimit;
            const showing = data.photos ? data.photos.length : 0;
            const start = offset + 1;
            const end = offset + showing;
            const hasPrev = offset > 0;
            const hasNext = offset + limit < total;

            // æ›´æ–°åç§»é‡
            currentOffset = offset;
            currentLimit = limit;

            statusContainer.innerHTML = `
                <span class="text-muted small">
                    Showing ${start}-${end} of ${total} photos
                    ${currentTaxonomyFilter ? ` | ç­›é€‰: ${currentTaxonomyFilter.type} = ${currentTaxonomyFilter.value}` : ''}
                </span>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary ${!hasPrev ? 'disabled' : ''}"
                            onclick="changePage(-${limit})">Previous</button>
                    <button class="btn btn-outline-secondary ${!hasNext ? 'disabled' : ''}"
                            onclick="changePage(${limit})">Next</button>
                    <button class="btn btn-outline-secondary" onclick="clearTaxonomyFilter()">æ¸…é™¤ç­›é€‰</button>
                </div>
            `;

            // åŒæ­¥æ¸²æŸ“åº•éƒ¨ç¿»é¡µæŒ‰é’®
            renderPaginationBottom(hasPrev, hasNext);
        }

        function renderPaginationBottom(hasPrev, hasNext) {
            const container = document.getElementById('pagination-bottom');
            if (!container) return;

            container.innerHTML = `
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary ${!hasPrev ? 'disabled' : ''}"
                            onclick="changePage(-${currentLimit})">Previous</button>
                    <button class="btn btn-outline-secondary ${!hasNext ? 'disabled' : ''}"
                            onclick="changePage(${currentLimit})">Next</button>
                    <button class="btn btn-outline-secondary" onclick="clearTaxonomyFilter()">æ¸…é™¤ç­›é€‰</button>
                </div>
            `;
        }

        function clearTaxonomyFilter() {
            currentTaxonomyFilter = null;
            currentOffset = 0;
            document.querySelectorAll('.tree-node.active').forEach(n => n.classList.remove('active'));

            // éšè—åˆ†ç±»ä¿¡æ¯é¢æ¿
            const infoPanel = document.getElementById('taxonomy-info');
            if (infoPanel) {
                infoPanel.classList.remove('expanded');
            }

            // Reload page
            window.location.href = '/';
        }

        // åˆ†é¡µå‡½æ•°
        function changePage(delta) {
            const newOffset = currentOffset + delta;
            if (newOffset < 0) return;

            if (currentTaxonomyFilter) {
                // å¸¦ç­›é€‰çš„åˆ†é¡µ
                const f = currentTaxonomyFilter;
                let url = `/api/photos/by_taxonomy?`;
                if (f.orderSsci) url += `order_sci=${encodeURIComponent(f.orderSsci)}&`;
                if (f.familySsci) url += `family_sci=${encodeURIComponent(f.familySsci)}&`;
                if (f.genusSsci) url += `genus_sci=${encodeURIComponent(f.genusSsci)}&`;
                if (f.value && f.type === 'species') url += `scientific_name=${encodeURIComponent(f.value)}&`;
                url += `limit=${currentLimit}&offset=${newOffset}`;
                updatePhotoGrid(url);
            } else {
                // æ— ç­›é€‰ï¼Œåˆ·æ–°é¡µé¢
                window.location.href = `/?limit=${currentLimit}&offset=${newOffset}`;
            }
        }

        // å±•å¼€æ‰€æœ‰èŠ‚ç‚¹
        function expandAll() {
            document.querySelectorAll('.tree-children').forEach(el => el.classList.add('expanded'));
            document.querySelectorAll('.tree-toggle').forEach(el => el.textContent = 'â–¼');

            // ä¿å­˜å±•å¼€çŠ¶æ€
            document.querySelectorAll('.tree-node[data-type]').forEach(node => {
                const type = node.dataset.type;
                const value = node.dataset.value;
                if (type && value) {
                    expandState[`${type}_${value}`] = true;
                }
            });
            if (CONFIG.rememberExpandState) {
                saveExpandState();
            }
        }

        // æŠ˜å æ‰€æœ‰èŠ‚ç‚¹
        function collapseAll() {
            document.querySelectorAll('.tree-children').forEach(el => el.classList.remove('expanded'));
            document.querySelectorAll('.tree-toggle').forEach(el => el.textContent = 'â–¶');

            // ä¿å­˜å±•å¼€çŠ¶æ€
            expandState = {};
            if (CONFIG.rememberExpandState) {
                saveExpandState();
            }
        }

        // å±•å¼€åˆ°ç›®çº§åˆ«
        function expandToOrderLevel() {
            collapseAll();
            document.querySelectorAll('.tree-node[data-type="order"]').forEach(node => {
                const children = node.nextElementSibling;
                if (children && children.classList.contains('tree-children')) {
                    children.classList.add('expanded');
                    const toggle = node.querySelector('.tree-toggle');
                    if (toggle) toggle.textContent = 'â–¼';
                    const type = node.dataset.type;
                    const value = node.dataset.value;
                    if (type && value) {
                        expandState[`${type}_${value}`] = true;
                    }
                }
            });
            if (CONFIG.rememberExpandState) {
                saveExpandState();
            }
        }

        // Show/Hide Empty Toggle
        const showEmptyToggle = document.getElementById('show-empty-toggle');
        if (showEmptyToggle) {
            showEmptyToggle.addEventListener('change', (e) => {
                loadTaxonomyTree(e.target.checked, null, CONFIG.defaultExpandLevel);
            });
        }

        // æŒ‰é’®äº‹ä»¶ç»‘å®š
        document.getElementById('expand-all-btn').addEventListener('click', expandAll);
        document.getElementById('collapse-all-btn').addEventListener('click', collapseAll);
        document.getElementById('reset-tree-btn').addEventListener('click', () => {
            loadTaxonomyTree(true, null, CONFIG.defaultExpandLevel);
        });

        // ========================
        // 2. Image Toggle (Raw/Processed)
        // ========================
        function attachImageToggleHandlers() {
            document.querySelectorAll('.main-img').forEach(img => {
                const rawSrc = img.dataset.raw;
                if (!rawSrc) return;

                img.addEventListener('mousedown', () => { img.src = rawSrc; });
                img.addEventListener('mouseup', () => { img.src = img.dataset.processed; });
                img.addEventListener('mouseleave', () => { img.src = img.dataset.processed; });
                img.addEventListener('touchstart', (e) => { e.preventDefault(); img.src = rawSrc; });
                img.addEventListener('touchend', () => { img.src = img.dataset.processed; });
            });
        }

        // ========================
        // 3. Edit Modal Logic
        // ========================
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        let currentPhotoId = null;

        function attachEditModalHandlers() {
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentPhotoId = btn.dataset.id;
                    document.getElementById('edit-photo-id').value = currentPhotoId;
                    document.getElementById('species-search').value = '';
                    document.getElementById('search-results').innerHTML = '';

                    const candidatesData = btn.dataset.candidates;
                    const candidatesList = document.getElementById('ai-candidates-list');
                    const candidatesSection = document.getElementById('ai-candidates-section');

                    candidatesList.innerHTML = '';
                    try {
                        const cands = JSON.parse(candidatesData);
                        if (cands && cands.length > 0) {
                            candidatesSection.classList.remove('d-none');
                            cands.forEach(c => {
                                const confPct = (c.score * 100).toFixed(1);
                                const item = document.createElement('button');
                                item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                                item.innerHTML = `
                                    <span>${c.cn} <small class="text-muted">(${c.sci})</small></span>
                                    <span class="badge bg-secondary rounded-pill">${confPct}%</span>
                                `;
                                item.onclick = () => selectSpecies(c.sci, c.cn);
                                candidatesList.appendChild(item);
                            });
                        } else {
                            candidatesSection.classList.add('d-none');
                        }
                    } catch(e) {
                        console.error("Failed to parse candidates", e);
                        candidatesSection.classList.add('d-none');
                    }

                    editModal.show();
                });
            });
        }

        // ========================
        // 4. Search Species
        // ========================
        const searchInput = document.getElementById('species-search');
        let debounceTimer;

        searchInput.addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const q = e.target.value;
                if (q.length < 2) return;

                fetch(`/api/search_species?q=${encodeURIComponent(q)}`)
                    .then(r => r.json())
                    .then(data => {
                        const html = data.map(sp => `
                            <a href="#" class="list-group-item list-group-item-action"
                               onclick="selectSpecies('${sp.scientific_name}', '${sp.chinese_name}')">
                               ${sp.chinese_name} <i>(${sp.scientific_name})</i>
                            </a>
                        `).join('');
                        document.getElementById('search-results').innerHTML = html;
                    });
            }, 300);
        });

        window.selectSpecies = (sci, cn) => {
            if (!confirm(`æ›´æ–°ä¸º ${cn}?`)) return;

            fetch('/api/update_label', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    photo_id: currentPhotoId,
                    scientific_name: sci,
                    chinese_name: cn
                })
            }).then(r => {
                if (r.ok) location.reload();
                else alert('æ›´æ–°å¤±è´¥');
            });
        };

        // Initial load
        loadExpandState();
        loadTaxonomyTree(CONFIG.includeEmptyNodes, null, CONFIG.defaultExpandLevel);
        attachImageToggleHandlers();
        attachEditModalHandlers();  // ç»‘å®šåˆå§‹é¡µé¢çš„Correct IDæŒ‰é’®
    </script>
</body>
</html>

#!/bin/bash
#===============================================================================
# FeatherTrace ä¸€é”®éƒ¨ç½²è„šæœ¬ - ä¸»å…¥å£
#===============================================================================

# ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$(dirname "${SCRIPT_DIR}")" && pwd)"

# è®¾ç½®ç¯å¢ƒå˜é‡
export PROJECT_ROOT
export DEBUG=0

# åŠ è½½é…ç½®
source "${SCRIPT_DIR}/lib/common.sh"
init_config_dir

#===============================================================================
# ä½¿ç”¨è¯´æ˜
#===============================================================================
usage() {
    cat << EOF
ğŸª¶ FeatherTrace ä¸€é”®éƒ¨ç½²è„šæœ¬

ç”¨æ³•: $0 [å‘½ä»¤]

å‘½ä»¤:
    install     å®‰è£…æ‰€æœ‰ä¾èµ–
    config      è¿è¡Œé…ç½®å‘å¯¼
    deploy      å®Œæ•´éƒ¨ç½²æµç¨‹ (å®‰è£… + é…ç½®)
    update      æ›´æ–°é¡¹ç›®
    model       ä¸‹è½½æ¨¡å‹
    web         å¯åŠ¨ Web ç•Œé¢
    tui         å¯åŠ¨äº¤äº’å¼ TUI ç•Œé¢
    help        æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

ç¤ºä¾‹:
    $0 deploy           # å®Œæ•´éƒ¨ç½²
    $0 config           # ä»…é…ç½®
    $0 web              # å¯åŠ¨ Web æœåŠ¡

EOF
    exit 0
}

#===============================================================================
# å®Œæ•´éƒ¨ç½²æµç¨‹
#===============================================================================
cmd_deploy() {
    echo ""
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘${NC}     ${WHITE}ğŸª¶ ç¾½è¿¹ FeatherTrace å®Œæ•´éƒ¨ç½²${NC}              ${CYAN}â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    # 1. æ£€æµ‹ç¯å¢ƒ
    log_step "1/4 æ£€æµ‹ç³»ç»Ÿç¯å¢ƒ..."
    source "${SCRIPT_DIR}/lib/detect.sh"
    detect_environment
    export_detection_results

    # 2. å®‰è£…ä¾èµ–
    log_step "2/4 å®‰è£…ç³»ç»Ÿä¾èµ–..."
    source "${SCRIPT_DIR}/lib/install.sh"

    if ! command_exists git; then
        install_git || log_warn "Git å®‰è£…å¤±è´¥"
    fi

    if ! detect_python >/dev/null 2>&1; then
        install_python || log_error "Python å®‰è£…å¤±è´¥"
    fi

    if ! command_exists exiftool; then
        install_exiftool || log_warn "ExifTool å®‰è£…å¤±è´¥"
    fi

    # 3. å®‰è£… Python ä¾èµ–
    log_step "3/4 å®‰è£… Python ä¾èµ–..."
    install_python_deps

    # 4. é…ç½®å‘å¯¼
    log_step "4/4 é…ç½®é¡¹ç›®..."
    source "${SCRIPT_DIR}/lib/config.sh"
    run_config_wizard

    # ç”Ÿæˆé…ç½®æ–‡ä»¶
    generate_settings_yaml
    generate_secrets_yaml

    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘${NC}              ${WHITE}âœ“ éƒ¨ç½²å®Œæˆ!${NC}                       ${GREEN}â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${WHITE}åç»­æ­¥éª¤:${NC}"
    echo "  1. ç¼–è¾‘ ${YELLOW}config/settings.yaml${NC} è°ƒæ•´è¯¦ç»†é…ç½®"
    echo "  2. è¿è¡Œ ${YELLOW}$0 web${NC} å¯åŠ¨ Web ç•Œé¢"
    echo "  3. æµè§ˆå™¨è®¿é—® http://localhost:8000"
    echo ""
}

#===============================================================================
# å®‰è£…ä¾èµ–
#===============================================================================
cmd_install() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘${NC}         ${WHITE}ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–${NC}                       ${CYAN}â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    source "${SCRIPT_DIR}/lib/detect.sh"
    source "${SCRIPT_DIR}/lib/install.sh"

    install_all_dependencies
    install_python_deps

    log_success "ä¾èµ–å®‰è£…å®Œæˆ"
}

#===============================================================================
# é…ç½®å‘å¯¼
#===============================================================================
cmd_config() {
    source "${SCRIPT_DIR}/lib/detect.sh"
    source "${SCRIPT_DIR}/lib/config.sh"

    run_config_wizard
    generate_settings_yaml
    generate_secrets_yaml
}

#===============================================================================
# æ›´æ–°é¡¹ç›®
#===============================================================================
cmd_update() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘${NC}         ${WHITE}ğŸ“¦ æ›´æ–°é¡¹ç›®${NC}                           ${CYAN}â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    source "${SCRIPT_DIR}/lib/clone.sh"

    if clone_project; then
        log_success "é¡¹ç›®å·²æ›´æ–°"
    else
        log_error "é¡¹ç›®æ›´æ–°å¤±è´¥"
    fi
}

#===============================================================================
# ä¸‹è½½æ¨¡å‹
#===============================================================================
cmd_model() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘${NC}         ${WHITE}â¬‡ï¸  ä¸‹è½½æ¨¡å‹${NC}                           ${CYAN}â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    source "${SCRIPT_DIR}/lib/clone.sh"

    if download_model; then
        log_success "æ¨¡å‹ä¸‹è½½å®Œæˆ"
    else
        log_error "æ¨¡å‹ä¸‹è½½å¤±è´¥"
    fi
}

#===============================================================================
# å¯åŠ¨ Web ç•Œé¢
#===============================================================================
cmd_web() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘${NC}         ${WHITE}ğŸŒ å¯åŠ¨ Web ç•Œé¢${NC}                      ${CYAN}â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    # æ£€æŸ¥ Python ä¾èµ–
    cd "$PROJECT_ROOT"

    if [ -f "${PROJECT_ROOT}/venv/Scripts/python" ]; then
        log_info "ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ Python"
        exec "${PROJECT_ROOT}/venv/Scripts/python" "${PROJECT_ROOT}/src/web/app.py"
    elif command_exists python3; then
        exec python3 "${PROJECT_ROOT}/src/web/app.py"
    else
        log_error "Python æœªå®‰è£…ï¼Œè¯·å…ˆè¿è¡Œ $0 install"
        exit 1
    fi
}

#===============================================================================
# å¯åŠ¨ TUI ç•Œé¢
#===============================================================================
cmd_tui() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘${NC}         ${WHITE}ğŸ¨ å¯åŠ¨ TUI ç•Œé¢${NC}                      ${CYAN}â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    # æ£€æŸ¥ TUI ä¾èµ–
    cd "$PROJECT_ROOT"

    if [ -f "${PROJECT_ROOT}/venv/Scripts/python" ]; then
        local python_venv="${PROJECT_ROOT}/venv/Scripts/python"
        local pip_venv="${PROJECT_ROOT}/venv/Scripts/pip"

        # æ£€æŸ¥ TUI ä¾èµ–
        if ! $python_venv -c "import rich; import questionary" 2>/dev/null; then
            log_info "å®‰è£… TUI ä¾èµ–..."
            $pip_venv install -r "${SCRIPT_DIR}/requirements_tui.txt"
        fi

        # è¿è¡Œ TUI
        exec $python_venv "${SCRIPT_DIR}/tui_main.py"
    else
        log_error "è™šæ‹Ÿç¯å¢ƒä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œ $0 install"
        exit 1
    fi
}

#===============================================================================
# æ£€æŸ¥ç¯å¢ƒ
#===============================================================================
cmd_check() {
    source "${SCRIPT_DIR}/lib/detect.sh"
    detect_environment
}

#===============================================================================
# æ˜¾ç¤ºå¸®åŠ©
#===============================================================================
cmd_help() {
    usage
}

#===============================================================================
# ä¸»å…¥å£
#===============================================================================
main() {
    # ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•
    cd "$PROJECT_ROOT"

    # è§£æå‘½ä»¤
    case "${1:-help}" in
        install|i)
            cmd_install
            ;;
        config|c)
            cmd_config
            ;;
        deploy|d)
            cmd_deploy
            ;;
        update|u)
            cmd_update
            ;;
        model|m)
            cmd_model
            ;;
        web|w)
            cmd_web
            ;;
        tui|t)
            cmd_tui
            ;;
        check|check_env)
            cmd_check
            ;;
        help|-h|--help|"")
            cmd_help
            ;;
        *)
            log_error "æœªçŸ¥å‘½ä»¤: $1"
            echo ""
            usage
            ;;
    esac
}

main "$@"

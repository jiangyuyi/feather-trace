# WingScribe 本地一体化部署配置
# 默认配置，所有服务运行在一起

version: '3.8'

services:
  wingscribe:
    build:
      context: .
      dockerfile: Dockerfile.cpu
    container_name: wingscribe
    ports:
      - "8000:8000"
    environment:
      - PLATFORM=cpu
    volumes:
      - ./config:/app/config
      - ./data:/app/data
      # 可选：挂载原始照片目录
      # - /path/to/photos:/app/data/source_photos:ro
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; r=requests.get('http://localhost:8000/api/recognition/health'); assert r.status_code == 200"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # 可选：GPU 服务（需要 nvidia-docker）
  wingscribe-gpu:
    build:
      context: .
      dockerfile: Dockerfile.gpu
    container_name: wingscribe-gpu
    ports:
      - "8001:8000"
    environment:
      - PLATFORM=gpu
      - CUDA_VISIBLE_DEVICES=0
    volumes:
      - ./config:/app/config
      - ./data:/app/data
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    profiles:
      - gpu  # 使用 --profile gpu 启动
